const firebaseConfig={apiKey:"AIzaSyB5ZAtw7K5-i7Lbsr1Lg8uQXVyxZjbkuvM",authDomain:"anime-x-lista.firebaseapp.com",projectId:"anime-x-lista",storageBucket:"anime-x-lista.appspot.com",messagingSenderId:"712102156874",appId:"1:712102156874:web:cdc5b9afc9492cf779e4b3"};firebase.initializeApp(firebaseConfig);const db=firebase.firestore();let myAnimeList=[];const list=document.getElementById("list");let searchResults=[];const resultList=document.querySelector("#resultList"),mainHTML=document.querySelector("html"),body=document.querySelector("body"),fixedAddButton=document.querySelector("#addbuttonatbottom");async function getListFromFirestore(){list.innerHTML="";try{let e=await db.collection("animes").doc("lista").get();if(e.exists){let t=e.data(),s=t.lista;if(s.forEach(e=>{let t=myAnimeList.findIndex(t=>t.id===e.id);-1===t?myAnimeList.push(e):myAnimeList[t]=e}),0===s.length){fixedAddButton.classList.add("d-none");let n=`
    <div class="blank-page-cover">
        <div class="display-3 fw-bold text-light-emphasis">AnimeX</div>
        <p class="lead text-light-emphasis fw-bold">Adicione aqui algum anime</p>
        <button class="btn btn-info col-6 col-sm-4 col-md-2" data-bs-toggle="modal" data-bs-target="#addAnimeModal">
            <i class="fa-solid fa-plus"></i> Add Anime
        </button>
    </div>
`;list.insertAdjacentHTML("beforeend",n)}else{fixedAddButton.classList.remove("d-none");document.querySelector("#animeCount").innerText=s.length;let a=localStorage.getItem("myAnimeList"),l=a?JSON.parse(a):[];function o(e,t){for(let n=e;n<Math.min(e+t,s.length);n++){let a=s[n],o={};a.watched===a.episodes?(o.text="Completo",o.class="text-orange fw-bold",o.color="text-orange"):a.watched>0&&a.watched<a.episodes?(o.text="Assistido",o.class="text-assistido",o.color=""):(o.text="N\xe3o Assistido",o.class="text-secondari",o.color="");let d=l.findIndex(e=>e.id===a.id),c=`
        <section class="list-item " id="${a.id}">
        <div class="position-relative rounded-3 d-flex flex-sm-column shadow overflow-hidden" style="background-color:#ffffff11;border:2px solid transparent">
            <div class="col-4 col-sm-12 position-relative" loading="lazy" style="background-image:url('${a.image}');background-size: cover; aspect-ratio:2/3">
                <div class="anime-name-oncover d-none d-sm-block">${a.name}</div>
            </div>
            <div class="col-8 col-sm-12 d-flex flex-column justify-content-between bg-black">
                <div class="text-center">
                    <div class="anime-name d-block py-2 p-2 d-sm-none">${a.name}</div>
                </div>
                <ul class="list-group list-group-flush">
                <li class="list-group-item bg-black">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="${o.class} small"><i class="fa-regular fa-eye d-none d-sm-inline"></i> ${o.text}</div>
                            <div class="d-flex justify-content-between align-items-center">
                            <button type="button" onclick="countDown(${a.id})" class="btn btn-lg1 border" aria-label="Diminuir contador"><i class="fa-solid fa-minus"></i></button>
                            <span class="px-2 fw-bold fs-2 watched-count">${a.watched}</span>
                            <button type="button" onclick="countUp(${a.id})" class="btn btn-lg2 border" aria-label="Aumentar contador"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item bg-black">
                        <div class="d-flex justify-content-between text-secondari">
                            <div class="small"><i class="fa-solid fa-bell d-none d-sm-inline"></i> Epis\xf3dios</div>
                            <div>${a.episodes}</div>
                        </div>
                    </li>
                    <li class="list-group-item position-relative bg-black">
                        <div class="d-flex flex-column text-secondari small">
                            <div><i class="fa-regular fa-circle-check d-none d-sm-inline"></i>  Nota</div>
                        </div>
                        <!-- Anime card menu btn -->
                        <div class="position-absolute end-0 bottom-0">
                            <div class="btn-group">
                            <div class="p-31 small" data-bs-toggle="dropdown" style="cursor:pointer">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                                </div>
                                <ul class="dropdown-menu shadow">
                                    <li><button type="button" class="dropdown-item" onclick="openEdit(${a.id})"><i class="fa-solid fa-edit me-2"></i>Editar</button></li>
                                    <li><button type="button" class="dropdown-item" onclick="removeAnimeFromFirestore('${a.id}')"><i class="fa-solid fa-trash me-2"></i> Excluir</button></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- Edid Panel -->
            <form id="editpanel-${a.id}" class="editpanel" style="display:none">
                <div class="form-floating mb-2 w-100">
                    <textarea minlength="3" type="text" class="form-control" id="inputName-${a.id}" style="height:5rem" required>${a.name}</textarea>
                    <label for="inputName-${a.id}"> Nome do Anime</label>
                </div>
                <div class="form-floating mb-2  w-100">
                    <input type="number" class="form-control" min="0" max="${a.episodes}" id="inputEpisodes-${a.id}" value="${a.watched}" required>
                    <label for="inputEpisodes-${a.id}">Epis\xf3dios Assistidos</label>
                </div>
                <div class="btn-group w-100">
                    <button type="button" class="btn btn-info btn-sm col-8 d-flex justify-content-center align-items-center" onclick="cancelEdit(${a.id})"> Cancelar
                    </button>
                    <button type="button" class="btn btn-info btn-sm col-8 d-flex justify-content-center align-items-center"
                    onclick="saveEdit(${a.id})">
                    <i class="fa-solid fa-floppy-disk me-2"></i>
                    <span> Atualizar</span></button>
                </div>
            </form>
        </div>
        
        </section>`;list.insertAdjacentHTML("beforeend",c),-1!==d&&listAnimation(d,s.indexOf(a))}}o(0,10);let d=10;setInterval(()=>{o(d,10),d+=10},1e3)}}else console.log("Nenhum documento encontrado no Firestore!")}catch(c){console.error("Erro ao recuperar lista de animes do Firestore: ",c)}}function listAnimation(e,t){setTimeout(()=>{childIndex=e+1,changedIndex=t+1;let s=document.querySelector("#list > section:nth-child("+childIndex+")");s&&s.classList.add("fade-up");document.querySelector("#list > section:nth-child("+changedIndex+")").classList.add("fade-down")},10)}checkLocalStorage(),db.collection("animes").doc("lista").get().then(e=>{if(e.exists){let t=e.data(),s=t.lista;console.log("Lista de animes",s),getListFromFirestore()}else console.log("Nenhum Anime encontrado!")}).catch(e=>{console.error("Erro ao recuperar lista: ",e)});const queryString=window.location.search,urlParams=new URLSearchParams(queryString),animeID=urlParams.get("anime");async function addbyURLparams(e){if(!myAnimeList.find(t=>t.id==e)){let t=await fetch("https://kitsu.io/api/edge/anime/"+e);if(t.ok){animeData=(await t.json()).data;pushList(new NewAnime(animeData.attributes.titles.en_jp,animeData.attributes.episodeCount,animeData.attributes.posterImage.medium,animeData.id))}}}function openEdit(e){let t=document.getElementById("editpanel-"+e);t.style.display="flex"}async function saveEdit(e){let t=document.getElementById("editpanel-"+e),s=document.getElementById("inputName-"+e).value,n=document.getElementById("inputEpisodes-"+e).value,a=myAnimeList.findIndex(t=>t.id==e);s!==myAnimeList[a].name&&(myAnimeList[a].name=s,updateAnimeInFirestore(myAnimeList[a])),n>myAnimeList[a].episodes?myAnimeList[a].watched=myAnimeList[a].episodes:myAnimeList[a].watched=n;let l={};myAnimeList[a].watched===myAnimeList[a].episodes?(l.text="Completo",l.class="text-orange fw-bold",l.color="text-orange"):myAnimeList[a].watched>0&&myAnimeList[a].watched<myAnimeList[a].episodes?(l.text="Assistido",l.class="text-secondari",l.color=""):(l.text="N\xe3o Assistido",l.class="text-muted",l.color="");let o=document.getElementById(e);if(o){let d=o.querySelector(".anime-name-oncover");d&&(d.textContent=s);let c=o.querySelector(".watched-count");c.innerText=myAnimeList[a].watched;let r=o.querySelector(".status");r&&(r.textContent=l.text,r.classList=l.class)}t.style.display="none",saveListToFirestore(myAnimeList)}function cancelEdit(e){let t=document.getElementById("editpanel-"+e);t.style.display="none"}function checkLocalStorage(){(localData=localStorage.getItem("myAnimeList"))&&(myAnimeList=JSON.parse(localData))}function updateLocalStorage(){localStorage.setItem("myAnimeList",JSON.stringify(myAnimeList))}function countUp(e){let t=myAnimeList.findIndex(t=>t.id==e);-1!==t&&myAnimeList[t].watched<myAnimeList[t].episodes&&(myAnimeList[t].watched++,myAnimeList[t].lastWatched=new Date().toLocaleString(),updateAnimeInFirestore(myAnimeList[t])),renderList()}function countDown(e){let t=myAnimeList.findIndex(t=>t.id==e);-1!==t&&myAnimeList[t].watched>0&&(myAnimeList[t].watched--,myAnimeList[t].lastWatched=0===myAnimeList[t].watched?"-":new Date().toLocaleString(),updateAnimeInFirestore(myAnimeList[t])),renderList()}function countBlink(e){let t=document.getElementById(e);t&&(t.firstElementChild.classList.add("item-blink"),setTimeout(()=>{t.firstElementChild.classList.remove("item-blink")},200))}function updateAnimeInFirestore(e){let t=db.collection("animes").doc("lista");t.get().then(s=>{if(s.exists){let n=s.data().lista,a=n.findIndex(t=>t.id===e.id);-1!==a?(n[a]=e,t.update({lista:n}).then(()=>{console.log("Anime atualizado!");let t=document.getElementById(e.id);if(t){let s=t.querySelector(".watched-count");s.innerText=e.watched}}).catch(e=>{console.error("Erro ao atualizar anime: ",e)})):console.error("Anime n\xe3o encontrado.")}else console.error("Lista de animes n\xe3o existe.")}).catch(e=>{console.error("Erro ao obter lista de animes: ",e)})}function renderList(){}animeID&&addbyURLparams(animeID);class NewAnime{constructor(e,t,s,n){this.name=e,this.episode=t,this.img=s,this.date="-",this.watched=0,this.id=n}}function addNewAnime(e,t,s,n){let a=myAnimeList.find(e=>e.id===n);if(!a){let l=new NewAnime(e,t,s,n),o=document.getElementById(n);o.classList.remove("btn-info"),o.disabled=!0,o.classList.add("btn-success"),o.firstElementChild.classList.remove("fa-plus"),o.firstElementChild.classList.add("fa-check"),pushList(l),saveListToFirestore(myAnimeList)}}function pushList(e){let t=myAnimeList.find(t=>t.id===e.id);if(!t){let s={name:e.name,episodes:e.episode,watched:e.watched,image:e.img,lastWatched:e.date,id:e.id};myAnimeList.unshift(s),getListFromFirestore()}}function saveListToFirestore(e){db.collection("animes").doc("lista").set({lista:e}).then(()=>{console.log("Lista de animes salva no Firestore!")}).catch(e=>{console.error("Erro ao salvar lista de animes: ",e)})}async function addNewAnimeToList(e){let t=myAnimeList.find(t=>t.name===e.name);if(!t){let s=myAnimeList.length>0?myAnimeList[myAnimeList.length-1].id:-1,n={name:e.name,episodes:e.episode,watched:e.watched,image:e.img,lastWatched:e.date,id:s+1};myAnimeList.push(n),saveListToFirestore(myAnimeList)}}function removeAnimeFromFirestore(e){let t=db.collection("animes").doc("lista"),s=parseInt(e);t.get().then(e=>{if(e.exists){let n=e.data().lista;console.log("ID do anime a ser removido:",s),console.log("IDs na lista:",n.map(e=>e.id));let a=n.findIndex(e=>parseInt(e.id)===s);-1!==a?(n.splice(a,1),t.update({lista:n}).then(()=>{console.log("Anime removido"),getListFromFirestore()}).catch(e=>{console.error("Erro ao remover anime: ",e)})):console.error("Anime n\xe3o encontrado na lista.")}else console.error("lista de animes n\xe3o existe.")}).catch(e=>{console.error("Erro ao obter lista de animes: ",e)})}async function fetchAnimeData(e){let t=document.querySelector(".spinner-border");t.classList.remove("d-none"),resultList.innerHTML="";let s=document.querySelector("#searchText").value,n;n="mostPopular"==e?await fetch("https://kitsu.io/api/edge/anime?page%5Blimit%5D=20&page%5Boffset%5D=0&sort=popularityRank,popularityRank"):"mostRating"==e?await fetch("https://kitsu.io/api/edge/anime?page%5Blimit%5D=20&page%5Boffset%5D=0&sort=-averageRating,-averageRating"):await fetch("https://kitsu.io/api/edge/anime?page%5Blimit%5D=20&page%5Boffset%5D=0&filter[text]="+s);let a=await n.json();if((searchResults=a.data).length>0)for(let l of searchResults){let o=`
<li class="list-group-item p-0 d-flex position-relative">
<img class="col-2" src="${l.attributes.posterImage.small}"/>
<div class="px-3 py-1 py-sm-2 col-10 d-flex flex-column bg-black">
    <div class="fw-bold">${l.attributes.titles.en_jp}</div>
    <div class="small">${l.attributes.canonicalTitle}</div>
    <span class="small">Episodes: ${l.attributes.episodeCount}</span>
    <div>
        <span class="badge w-auto bg-body-secondary text-secondari-emphasis">Rating: ${l.attributes.averageRating}</span>
        <span class="badge w-auto bg-body-secondary text-secondari-emphasis">Popularity: # ${l.attributes.popularityRank}</span>
    </div>
    
    <button id="${l.id}" class="rounded-circle position-absolute btn btn-sm btn-info end-0 bottom-0 m-2" style="width:2rem; height:2rem"
    onclick="addNewAnime('${l.attributes.titles.en_jp}', ${l.attributes.episodeCount}, '${l.attributes.posterImage.medium}', ${l.id})">
    <i class="fa-solid fa-plus"></i>
</button>
</div>
</li>
`;resultList.insertAdjacentHTML("beforeend",o)}else resultList.innerHTML="OOPS! >_<";t.classList.add("d-none")}const datalistOptions=[],AnimeXDatalist=document.getElementById("AnimeXDatalist");for(let i=0;i<datalistOptions.length;i++){let e=`<option value="${datalistOptions[i]}">`;AnimeXDatalist.insertAdjacentHTML("beforeend",e)}function searchAnime(){let e=document.getElementById("searchAnimeTxT");if(""===e.value.trim()){getListFromFirestore();return}let t=myAnimeList.filter(t=>t.name.toLowerCase().includes(e.value.toLowerCase()));renderSearchResults(t)}const searchInput=document.getElementById("searchAnimeTxT");function renderSearchResults(e){if(list.innerHTML="",0===e.length){list.innerHTML="<p>Nenhum anime correspondente encontrado.</p>",updateAnimeCount(0);return}e.forEach(e=>{let t={};e.watched===e.episodes?(t.text="Completo",t.class="text-orange fw-bold",t.color="text-orange"):e.watched>0&&e.watched<e.episodes?(t.text="Assistido",t.class="text-assistido",t.color=""):(t.text="N\xe3o Assistido",t.class="text-secondari",t.color="");let s=`
<section class="list-item " id="${e.id}">
<div class="position-relative rounded-3 d-flex flex-sm-column shadow overflow-hidden" style="background-color:#ffffff11;border:2px solid transparent">
<div class="col-4 col-sm-12 position-relative" loading="lazy" style="background-image:url('${e.image}');background-size: cover; aspect-ratio:2/3">
<div class="anime-name-oncover d-none d-sm-block">${e.name}</div>
</div>
<div class="col-8 col-sm-12 d-flex flex-column justify-content-between bg-black">
<div class="text-center">
    <div class="anime-name d-block py-2 p-2 d-sm-none">${e.name}</div>
</div>
<ul class="list-group list-group-flush">
<li class="list-group-item bg-black">
        <div class="d-flex justify-content-between align-items-center">
            <div class="${t.class} small"><i class="fa-regular fa-eye d-none d-sm-inline"></i> ${t.text}</div>
            <div class="d-flex justify-content-between align-items-center">
            <button type="button" onclick="countDown(${e.id})" class="btn btn-lg1 border" aria-label="Diminuir contador"><i class="fa-solid fa-minus"></i></button>
            <span class="px-2 fw-bold fs-2 watched-count">${e.watched}</span>
            <button type="button" onclick="countUp(${e.id})" class="btn btn-lg2 border" aria-label="Aumentar contador"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
    </li>
    <li class="list-group-item bg-black">
        <div class="d-flex justify-content-between text-secondari">
            <div class="small"><i class="fa-solid fa-bell d-none d-sm-inline"></i> Epis\xf3dios</div>
            <div>${e.episodes}</div>
        </div>
    </li>
    <li class="list-group-item position-relative bg-black">
        <div class="d-flex flex-column text-secondari small">
            <div><i class="fa-regular fa-circle-check d-none d-sm-inline"></i> \xdaltima visualiza\xe7\xe3o</div>
            <div>${e.lastWatched}</div>
        </div>
        <!-- Anime card menu btn -->
        <div class="position-absolute end-0 bottom-0">
            <div class="btn-group">
            <div class="p-31 small" data-bs-toggle="dropdown" style="cursor:pointer">
                <i class="fa-solid fa-ellipsis-vertical"></i>
                </div>
                <ul class="dropdown-menu shadow">
                    <li><button type="button" class="dropdown-item" onclick="openEdit(${e.id})"><i class="fa-solid fa-edit me-2"></i>Editar</button></li>
                    <li><button type="button" class="dropdown-item" onclick="removeAnimeFromFirestore('${e.id}')"><i class="fa-solid fa-trash me-2"></i> Excluir</button></li>
                </ul>
            </div>
        </div>
    </li>
</ul>
</div>
<!-- Edid Panel -->
<form id="editpanel-${e.id}" class="editpanel" style="display:none">
<div class="form-floating mb-2 w-100">
    <textarea minlength="3" type="text" class="form-control" id="inputName-${e.id}" style="height:5rem" required>${e.name}</textarea>
    <label for="inputName-${e.id}"> Nome do Anime</label>
</div>
<div class="form-floating mb-2  w-100">
    <input type="number" class="form-control" min="0" max="${e.episodes}" id="inputEpisodes-${e.id}" value="${e.watched}" required>
    <label for="inputEpisodes-${e.id}">Epis\xf3dios Assistidos</label>
</div>
<div class="btn-group w-100">
    <button type="button" class="btn btn-secondary btn-sm col-4 small" onclick="cancelEdit(${e.id})"> Cancelar
    </button>
    <button type="button" class="btn btn-info btn-sm col-8 d-flex justify-content-center align-items-center"
    onclick="saveEdit(${e.id})">
    <i class="fa-solid fa-floppy-disk me-2"></i>
    <span> Atualizar</span></button>
</div>
</form>
</div>

</section>`;list.insertAdjacentHTML("beforeend",s)}),updateAnimeCount(e.length)}function updateAnimeCount(e){document.querySelector("#animeCount").innerText=e}searchInput.addEventListener("input",searchAnime);